services:
  # Main build service - runs all three builds sequentially in one container
  build-all:
    image: zmkfirmware/zmk-build-arm:stable
    container_name: zmk-corne-build-all
    volumes:
      - .:/workspace
      - zmk-cache:/zmk-workspace
    working_dir: /zmk-workspace
    environment:
      - ZEPHYR_VERSION=4.1.0
      - ZEPHYR_SDK_VERSION=0.16.9
    command:
      - bash
      - -c
      - |
        set -e
        echo '=== Building ZMK Firmware ==='
        echo ''
        # Always ensure config is present
        rm -rf config
        cp -r /workspace/config ./
        if [ ! -f ".west/config" ]; then
          echo 'Initializing west workspace...'
          west init -l config
        fi
        if [ ! -d "zmk" ]; then
          echo 'Updating west dependencies...'
          west update
        else
          echo '✓ West dependencies already cached'
        fi
        echo 'Setting up Zephyr environment...'
        west zephyr-export
        echo ''
        echo '=== Building all devices in parallel ==='
        echo 'Starting DONGLE build...'
        west build -s zmk/app -d /workspace/build/dongle -b nice_nano_v2 -- -DZMK_CONFIG=/workspace/config -DSHIELD='eyeslash_corne_central_dongle dongle_display' -DZMK_EXTRA_MODULES=/workspace > /tmp/dongle.log 2>&1 &
        DONGLE_PID=$!
        echo 'Starting LEFT build...'
        west build -s zmk/app -d /workspace/build/left -b nice_nano_v2 -- -DZMK_CONFIG=/workspace/config -DSHIELD='eyeslash_corne_peripheral_left nice_oled' -DZMK_EXTRA_MODULES=/workspace > /tmp/left.log 2>&1 &
        LEFT_PID=$!
        echo 'Starting RIGHT build...'
        west build -s zmk/app -d /workspace/build/right -b nice_nano_v2 -- -DZMK_CONFIG=/workspace/config -DSHIELD='eyeslash_corne_peripheral_right nice_oled' -DZMK_EXTRA_MODULES=/workspace > /tmp/right.log 2>&1 &
        RIGHT_PID=$!
        echo ''
        echo 'Waiting for builds to complete...'
        wait $DONGLE_PID && echo '✓ DONGLE build complete' || (echo '✗ DONGLE build failed' && cat /tmp/dongle.log && exit 1)
        wait $LEFT_PID && echo '✓ LEFT build complete' || (echo '✗ LEFT build failed' && cat /tmp/left.log && exit 1)
        wait $RIGHT_PID && echo '✓ RIGHT build complete' || (echo '✗ RIGHT build failed' && cat /tmp/right.log && exit 1)
        echo ''
        echo '=== Build Complete! ==='
        echo 'Outputs in /workspace/build/{dongle,left,right}/zephyr/zmk.uf2'

volumes:
  zmk-cache:
    driver: local
