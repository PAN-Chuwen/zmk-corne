services:
  # Main build service - runs all three builds sequentially in one container
  build-all:
    image: zmkfirmware/zmk-build-arm:stable
    container_name: zmk-corne-build-all
    volumes:
      - .:/workspace
      - zmk-cache:/zmk-workspace
    working_dir: /zmk-workspace
    environment:
      - ZEPHYR_VERSION=4.1.0
      - ZEPHYR_SDK_VERSION=0.16.9
    command:
      - bash
      - -c
      - |
        set -e
        echo '=== Building ZMK Firmware ==='
        echo ''
        # Always ensure config is present
        rm -rf config
        cp -r /workspace/config ./
        if [ ! -f ".west/config" ]; then
          echo 'Initializing west workspace...'
          west init -l config
        fi
        if [ ! -d "zmk" ]; then
          echo 'Updating west dependencies...'
          west update
        else
          echo 'âœ“ West dependencies already cached'
        fi
        echo 'Setting up Zephyr environment...'
        west zephyr-export
        echo ''
        echo 'Building DONGLE (central)...'
        west build -s zmk/app -d /workspace/build/dongle -b nice_nano_v2 -- -DZMK_CONFIG=/workspace/config -DSHIELD='eyeslash_corne_central_dongle dongle_display' -DZMK_EXTRA_MODULES=/workspace
        echo ''
        echo 'Building LEFT (peripheral)...'
        west build -s zmk/app -d /workspace/build/left -b nice_nano_v2 -- -DZMK_CONFIG=/workspace/config -DSHIELD='eyeslash_corne_peripheral_left nice_view_custom' -DZMK_EXTRA_MODULES=/workspace
        echo ''
        echo 'Building RIGHT (peripheral)...'
        west build -s zmk/app -d /workspace/build/right -b nice_nano_v2 -- -DZMK_CONFIG=/workspace/config -DSHIELD='eyeslash_corne_peripheral_right nice_view_custom' -DZMK_EXTRA_MODULES=/workspace
        echo ''
        echo '=== Build Complete! ==='
        echo 'Outputs in /workspace/build/{dongle,left,right}/zephyr/zmk.uf2'

volumes:
  zmk-cache:
    driver: local
